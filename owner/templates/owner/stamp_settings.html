<!-- C:\Users\j_tagami\CiquestWebApp\owner\templates\owner\stamp_settings.html -->
{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="{% static 'img/common/CIquest.ico' %}" type="image/x-icon">
  <title>スタンプ設定 - CiQuest オーナー</title>
  <link rel="stylesheet" href="{% static 'css/base/base.css' %}">
  <link rel="stylesheet" href="{% static 'css/owner/common.css' %}">
  <link rel="stylesheet" href="{% static 'css/owner/stamp_settings.css' %}">
</head>
<body>
  <header>
    <h1>{{ store.name }} のスタンプイベント管理</h1>
    <nav>
      <a href="{% url 'owner_store_home' store.store_id %}">ホーム</a>
      <a href="{% url 'create_challenge' %}">チャレンジ作成</a>
      <a href="{% url 'create_coupon' %}">クーポン作成</a>
      <a href="{% url 'coupon_list' %}">クーポン一覧</a>
      <a href="{% url 'my_challenges' %}">チャレンジ一覧</a>
      <a href="{% url 'stamp_settings' %}" class="active">スタンプ設定</a>
      <a href="{% url 'stats' %}">統計</a>
    </nav>
  </header>
  <div class="nav-secondary">
    <a href="{% url 'owner_dashboard' %}" class="nav-secondary__link">店舗一覧</a>
  </div>

  <main class="stamp-settings-container">
    {% if messages %}
      <div class="page-messages">
        {% for message in messages %}
          <div class="message message-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <section class="card card-settings">
      <div class="card-settings-header">
        <div>
          <p class="eyebrow">Stamp Card</p>
          <h2>スタンプカード設定</h2>
          <p>カードは店舗ごとに1つだけです。最大スタンプ数を設定し、保存するとカードが作成／更新されます。</p>
        </div>
        {% if setting %}
          <form method="post" action="{% url 'delete_stamp_settings' %}" onsubmit="return confirm('スタンプカードを削除すると、登録済みイベントも全て削除されます。よろしいですか？');">
            {% csrf_token %}
            <button type="submit" class="btn danger outline">カードを削除</button>
          </form>
        {% endif %}
      </div>

      <form method="post" action="{% url 'stamp_settings' %}" class="card-settings-form">
        {% csrf_token %}
        <input type="hidden" name="intent" value="update_card">
        <label for="max_stamps">最高スタンプ数（1〜30）</label>
        <div class="max-controls">
          <input type="range" id="max_stamps_slider" min="1" max="30" value="{{ max_stamps|default:30 }}">
          <input type="number" id="max_stamps" name="max_stamps" min="1" max="30" value="{{ max_stamps|default:30 }}" required>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn primary">
            {% if setting %}設定を更新{% else %}カードを作成{% endif %}
          </button>
        </div>
      </form>
    </section>

    <section class="card event-list">
      <div class="section-heading">
        <div>
          <p class="eyebrow">Events</p>
          <h2>スタンプイベント一覧</h2>
        </div>
        <span class="count-pill">{{ events|length }} 件</span>
      </div>

      {% if setting %}
        {% if events %}
          <div class="event-table-wrapper">
            <div class="event-row header">
              <span>スタンプ数</span>
              <span>タイプ</span>
              <span>報酬内容</span>
              <span>操作</span>
            </div>
            {% for reward in events %}
              <div class="event-row">
                <span>{{ reward.stamp_threshold }}</span>
                <span>{% if reward.reward_type == 'coupon' %}クーポン{% else %}サービス{% endif %}</span>
                <span>
                  {% if reward.reward_type == 'coupon' and reward.reward_coupon %}
                    {{ reward.reward_coupon.title }}
                  {% elif reward.reward_type == 'service' %}
                    {{ reward.reward_service_desc|default:"内容未設定" }}
                  {% else %}
                    -
                  {% endif %}
                </span>
                <span class="row-actions">
                  <a class="btn ghost" href="{% url 'edit_stamp_event' reward.pk %}">編集</a>
                  <form method="post" action="{% url 'delete_stamp_event' reward.pk %}" onsubmit="return confirm('イベントを削除しますか？');">
                    {% csrf_token %}
                    <button type="submit" class="btn danger ghost">削除</button>
                  </form>
                </span>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="empty-notice">イベントは登録されていません。下のボタンから追加しましょう。</p>
        {% endif %}
        <div class="event-footer">
          <a class="btn primary" href="{% url 'create_stamp_event' %}">+ 新しいイベントを作成</a>
        </div>
      {% else %}
        <p class="empty-notice">スタンプカードを先に作成してください。</p>
      {% endif %}
    </section>
  </main>

  <footer>
    <p>© 2025 CiQuest Owner Panel</p>
  </footer>

  <script>
    const slider = document.getElementById('max_stamps_slider');
    const numberInput = document.getElementById('max_stamps');
    if (slider && numberInput) {
      slider.addEventListener('input', (event) => {
        numberInput.value = event.target.value;
      });
      numberInput.addEventListener('input', (event) => {
        const value = Math.min(30, Math.max(1, Number(event.target.value) || 1));
        event.target.value = value;
        slider.value = value;
      });
    }
  </script>
</body>
</html>
