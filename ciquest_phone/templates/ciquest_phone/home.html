<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ciquest | ホーム</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;500;700;900&display=swap');

      :root {
        color-scheme: light;
        --sky-light: #e6f8ff;
        --sky-mid: #bfe7ff;
        --sky-deep: #1f87d4;
        --navy: #0c3757;
        --text-primary: #0c2d44;
        --text-secondary: #41607a;
        --glass: rgba(255, 255, 255, 0.6);
        --glass-strong: rgba(255, 255, 255, 0.85);
        --card: rgba(255, 255, 255, 0.76);
        --border: rgba(255, 255, 255, 0.7);
        --shadow: rgba(8, 74, 120, 0.25);
        --danger: #c0392b;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: 'Zen Kaku Gothic New', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', sans-serif;
        background: linear-gradient(180deg, var(--sky-light) 0%, var(--sky-mid) 55%, #f7fbff 100%);
        min-height: 100vh;
        color: var(--text-primary);
      }

      .aero-bubble {
        position: fixed;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.35);
        border: 1px solid rgba(255, 255, 255, 0.6);
        filter: blur(0.3px);
        z-index: 0;
      }

      .bubble-1 {
        width: 220px;
        height: 220px;
        top: -60px;
        left: -40px;
      }

      .bubble-2 {
        width: 180px;
        height: 180px;
        top: 140px;
        right: -60px;
      }

      .bubble-3 {
        width: 150px;
        height: 150px;
        bottom: 120px;
        left: -40px;
      }

      .shell {
        position: relative;
        z-index: 1;
        padding: 18px 14px 20px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .header-pill {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 12px 16px;
        border-radius: 16px;
        border: 1px solid var(--border);
        background: linear-gradient(145deg, var(--glass-strong), var(--glass));
        box-shadow: 0 4px 10px var(--shadow);
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .header-logo {
        width: 44px;
        height: 44px;
        border-radius: 8px;
        object-fit: cover;
      }

      .header-title {
        font-size: 20px;
        font-weight: 700;
        letter-spacing: 0.04em;
      }

      .notice-button {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(31, 135, 212, 0.9);
        color: #fff;
        border: none;
        font-size: 12px;
        font-weight: 700;
        cursor: pointer;
        text-decoration: none;
        box-shadow: 0 4px 6px rgba(8, 74, 120, 0.25);
      }

      .notice-button svg {
        width: 16px;
        height: 16px;
        fill: #fff;
      }

      .map-card {
        flex: 1;
        position: relative;
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid var(--border);
        box-shadow: 0 8px 14px rgba(8, 74, 120, 0.2);
        min-height: 520px;
      }

      #map {
        position: absolute;
        inset: 0;
      }

      .map-overlay {
        position: absolute;
        inset: 0;
        padding: 16px;
        background: rgba(255, 255, 255, 0.08);
        pointer-events: none;
      }

      .map-title-row {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
      }

      .map-title {
        font-size: 16px;
        font-weight: 700;
      }

      .map-caption {
        font-size: 12px;
        color: var(--text-secondary);
      }

      .map-bottom {
        position: absolute;
        left: 16px;
        right: 16px;
        bottom: 14px;
      }

      .map-hint {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 8px;
      }

      .action-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 14px;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: var(--card);
        font-weight: 700;
        font-size: 14px;
        color: var(--navy);
        cursor: pointer;
        pointer-events: auto;
      }

      .action-chip svg {
        width: 20px;
        height: 20px;
        fill: var(--navy);
      }

      .error-text {
        margin-top: 8px;
        color: var(--danger);
        font-size: 12px;
        font-weight: 600;
      }

      .loading-badge {
        position: absolute;
        right: 12px;
        bottom: 90px;
        display: flex;
        align-items: center;
        gap: 6px;
        background: var(--glass-strong);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 6px 10px;
        font-size: 11px;
        color: var(--text-secondary);
      }

      .sheet-overlay {
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.2);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
        z-index: 2;
      }

      .sheet-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }

      .sheet-container {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 0 12px 12px;
        transform: translateY(260px);
        transition: transform 0.35s ease;
        z-index: 3;
      }

      .sheet-container.active {
        transform: translateY(0);
      }

      .info-card {
        background: var(--card);
        border-radius: 14px;
        padding: 14px;
        border: 1px solid var(--border);
        box-shadow: 0 6px 12px rgba(8, 74, 120, 0.18);
        min-height: 180px;
      }

      .sheet-handle {
        width: 48px;
        height: 4px;
        border-radius: 999px;
        background: #d3deea;
        margin: 0 auto 10px;
      }

      .info-title {
        font-weight: 700;
        text-align: center;
        margin-top: 6px;
      }

      .info-sub {
        text-align: center;
        font-size: 13px;
        color: var(--text-secondary);
        margin-top: 6px;
      }

      .info-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 10px;
      }

      .store-name {
        font-size: 16px;
        font-weight: 700;
      }

      .store-desc {
        margin-top: 4px;
        font-size: 13px;
        color: var(--text-secondary);
      }

      .store-distance {
        font-weight: 700;
        color: var(--sky-deep);
      }

      .store-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-top: 12px;
      }

      .tag-pill {
        display: inline-flex;
        align-items: center;
        padding: 6px 10px;
        border-radius: 999px;
        background: var(--glass-strong);
        color: var(--sky-deep);
        font-weight: 700;
        font-size: 12px;
      }

      .footer-actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .link-button {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: var(--sky-deep);
        font-weight: 700;
        font-size: 13px;
        text-decoration: none;
      }

      .link-button svg {
        width: 16px;
        height: 16px;
        fill: var(--sky-deep);
      }

      .detail-link {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 6px 10px;
        border-radius: 999px;
        background: var(--glass-strong);
        color: var(--sky-deep);
        font-weight: 700;
        font-size: 12px;
        text-decoration: none;
      }

      .close-button {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        margin-top: 12px;
        align-self: flex-end;
        color: var(--text-secondary);
        font-weight: 700;
        cursor: pointer;
        text-decoration: none;
      }

      .location-guard {
        position: fixed;
        inset: 0;
        background: linear-gradient(180deg, rgba(230, 248, 255, 0.96), rgba(191, 231, 255, 0.98));
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
        z-index: 20;
        text-align: center;
      }

      .guard-card {
        background: var(--glass-strong);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 28px 22px;
        max-width: 360px;
        box-shadow: 0 12px 30px rgba(8, 74, 120, 0.18);
      }

      .guard-card h2 {
        margin: 12px 0 10px;
        font-size: 20px;
      }

      .guard-card p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 14px;
        line-height: 1.6;
      }

      .guard-button {
        margin-top: 18px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 12px 18px;
        border-radius: 999px;
        background: var(--sky-deep);
        color: #fff;
        font-weight: 700;
        font-size: 14px;
        border: none;
        cursor: pointer;
      }

      .guard-hint {
        margin-top: 14px;
        font-size: 12px;
        color: var(--text-secondary);
      }

      @media (max-width: 720px) {
        .map-card {
          min-height: 480px;
        }
      }
    </style>
  </head>
  <body>
    <div class="aero-bubble bubble-1"></div>
    <div class="aero-bubble bubble-2"></div>
    <div class="aero-bubble bubble-3"></div>

    <div class="shell">
      <header class="header-pill">
        <div class="header-left">
          <img class="header-logo" src="/static/ciquest_phone/img/icon.png" alt="Ciquest" />
          <div class="header-title">Ciquest</div>
        </div>
        <a class="notice-button" href="{% url 'ciquest_phone_notices' %}">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 22a2.5 2.5 0 0 0 2.45-2h-4.9A2.5 2.5 0 0 0 12 22zm7-6V11a7 7 0 0 0-5.5-6.8V3a1.5 1.5 0 0 0-3 0v1.2A7 7 0 0 0 5 11v5l-2 2v1h18v-1l-2-2z"/>
          </svg>
          お知らせ
        </a>
      </header>

      <section class="map-card">
        <div id="map"></div>
        <div class="map-overlay">
          <div class="map-title-row">
            <div class="map-title">お店マップ</div>
            <div class="map-caption">現在地からの距離は仮のデータです。</div>
          </div>
          <div class="map-bottom">
            <div class="map-hint">ピンをタップして店舗情報を表示</div>
            <button class="action-chip" id="locate-btn" type="button">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 2a1 1 0 0 1 1 1v1.06A8.002 8.002 0 0 1 19.94 11H21a1 1 0 1 1 0 2h-1.06A8.002 8.002 0 0 1 13 19.94V21a1 1 0 1 1-2 0v-1.06A8.002 8.002 0 0 1 4.06 13H3a1 1 0 1 1 0-2h1.06A8.002 8.002 0 0 1 11 4.06V3a1 1 0 0 1 1-1zm0 4a6 6 0 1 0 0 12a6 6 0 0 0 0-12z"/>
              </svg>
              現在地に移動
            </button>
            <div class="error-text" id="location-error" style="display:none"></div>
            <div class="error-text" id="fetch-error" style="display:none"></div>
          </div>
          <div class="loading-badge" id="loading-badge" style="display:none">
            <span>位置情報取得中</span>
          </div>
        </div>

        <div class="sheet-overlay" id="sheet-overlay"></div>
        <div class="sheet-container" id="sheet-container">
          <div class="info-card" id="info-card">
            <div class="sheet-handle"></div>
            <div class="info-title">ピンをタップすると店舗情報が表示されます。</div>
            <div class="info-sub">本番では地図SDKに置き換え予定です。</div>
          </div>
        </div>
      </section>
    </div>

    <div class="location-guard" id="location-guard" style="display:none">
      <div class="guard-card">
        <svg viewBox="0 0 24 24" width="46" height="46" aria-hidden="true">
          <path fill="#1f87d4" d="M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7zm0 9.5A2.5 2.5 0 1 1 12 6a2.5 2.5 0 0 1 0 5.5z"/>
        </svg>
        <h2>位置情報の許可が必要です</h2>
        <p>不正対策のため、位置情報の権限が許可されない場合はアプリを利用できません。</p>
        <button class="guard-button" id="guard-btn" type="button">位置情報を許可する</button>
        <div class="guard-hint" id="guard-hint" style="display:none">端末の設定で位置情報の許可を有効にしてください。</div>
      </div>
    </div>

    {{ stores|json_script:"store-data" }}
    <script>
      const STORE_DATA = JSON.parse(document.getElementById('store-data').textContent || '[]');
      const MAP_STYLE = [
        { featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.business', elementType: 'all', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.attraction', elementType: 'all', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.government', elementType: 'all', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.medical', elementType: 'all', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.park', elementType: 'labels', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.place_of_worship', elementType: 'all', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.school', elementType: 'all', stylers: [{ visibility: 'off' }] },
        { featureType: 'poi.sports_complex', elementType: 'all', stylers: [{ visibility: 'off' }] },
        { featureType: 'transit.station', elementType: 'labels', stylers: [{ visibility: 'off' }] },
      ];

      const mapState = {
        map: null,
        markers: [],
        selectedStore: null,
        lastPosition: null,
        centered: false,
      };

      const overlay = document.getElementById('sheet-overlay');
      const sheet = document.getElementById('sheet-container');
      const infoCard = document.getElementById('info-card');
      const locationError = document.getElementById('location-error');
      const fetchError = document.getElementById('fetch-error');
      const loadingBadge = document.getElementById('loading-badge');
      const locateButton = document.getElementById('locate-btn');
      const guard = document.getElementById('location-guard');
      const guardBtn = document.getElementById('guard-btn');
      const guardHint = document.getElementById('guard-hint');

      const defaultCenter = { lat: 36.5551, lng: 139.8828 };

      function showGuard(showHint) {
        guard.style.display = 'flex';
        guardHint.style.display = showHint ? 'block' : 'none';
      }

      function hideGuard() {
        guard.style.display = 'none';
      }

      function setError(target, message) {
        if (!message) {
          target.style.display = 'none';
          target.textContent = '';
          return;
        }
        target.style.display = 'block';
        target.textContent = message;
      }

      function toggleLoading(state) {
        loadingBadge.style.display = state ? 'flex' : 'none';
      }

      function setSheetActive(active) {
        if (active) {
          sheet.classList.add('active');
          overlay.classList.add('active');
        } else {
          sheet.classList.remove('active');
          overlay.classList.remove('active');
        }
      }

      function renderInfoCard(store) {
        if (!store) {
          infoCard.innerHTML = `
            <div class="sheet-handle"></div>
            <div class="info-title">ピンをタップすると店舗情報が表示されます。</div>
            <div class="info-sub">本番では地図SDKに置き換え予定です。</div>
          `;
          setSheetActive(false);
          return;
        }
        const distanceLabel = typeof store.distance === 'number' ? `${store.distance}m` : '-';
        infoCard.innerHTML = `
          <div class="sheet-handle"></div>
          <div class="info-header">
            <div>
              <div class="store-name">${store.name}</div>
              <div class="store-desc">${store.description || ''}</div>
            </div>
            <div class="store-distance">${distanceLabel}</div>
          </div>
          <div class="store-footer">
            <div class="tag-pill">${store.tag || ''}</div>
            <div class="footer-actions">
              <a class="link-button" href="https://www.google.com/maps?q=${store.lat},${store.lon}" target="_blank" rel="noopener">
                Googleマップで開く
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M14 3h7v7h-2V6.41l-9.29 9.3-1.42-1.42L17.59 5H14V3z"/>
                  <path d="M5 5h6V3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-6h-2v6H5V5z"/>
                </svg>
              </a>
              <a class="detail-link" href="/phone-django/stores/${store.id}/">詳細
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path fill="currentColor" d="M9.29 6.71a1 1 0 0 0 0 1.41L13.17 12l-3.88 3.88a1 1 0 1 0 1.42 1.41l4.59-4.59a1 1 0 0 0 0-1.41L10.71 6.7a1 1 0 0 0-1.42 0z"/>
                </svg>
              </a>
            </div>
          </div>
          <a class="close-button" href="javascript:void(0)">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path fill="currentColor" d="M7.41 8.59a1 1 0 0 1 1.42 0L12 11.76l3.17-3.17a1 1 0 0 1 1.42 1.41l-3.88 3.88a1 1 0 0 1-1.42 0L7.41 10a1 1 0 0 1 0-1.41z"/>
            </svg>
            閉じる
          </a>
        `;
        const close = infoCard.querySelector('.close-button');
        close.addEventListener('click', () => {
          renderInfoCard(null);
        });
        setSheetActive(true);
      }

      function computeDistanceMeters(lat1, lon1, lat2, lon2) {
        const toRad = (v) => (v * Math.PI) / 180;
        const r = 6371;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
        return r * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)) * 1000;
      }

      function updateDistances() {
        if (!mapState.lastPosition) return;
        STORE_DATA.forEach((store) => {
          if (typeof store.lat === 'number' && typeof store.lon === 'number') {
            store.distance = Math.round(
              computeDistanceMeters(
                mapState.lastPosition.lat,
                mapState.lastPosition.lng,
                store.lat,
                store.lon
              )
            );
          }
        });
      }

      function selectStore(store) {
        mapState.selectedStore = store;
        renderInfoCard(store);
      }

      function closeSheet() {
        mapState.selectedStore = null;
        renderInfoCard(null);
      }

      function initMarkers() {
        mapState.markers.forEach((marker) => marker.setMap(null));
        mapState.markers = [];

        STORE_DATA.forEach((store) => {
          if (typeof store.lat !== 'number' || typeof store.lon !== 'number') return;
          const marker = new google.maps.Marker({
            map: mapState.map,
            position: { lat: store.lat, lng: store.lon },
            title: store.name,
          });
          marker.addListener('click', () => selectStore(store));
          mapState.markers.push(marker);
        });
      }

      function ensureLocationPermission() {
        return new Promise((resolve) => {
          if (!navigator.geolocation) {
            setError(locationError, '位置情報を取得できませんでした。');
            showGuard(true);
            resolve(false);
            return;
          }
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              mapState.lastPosition = { lat: pos.coords.latitude, lng: pos.coords.longitude };
              updateDistances();
              setError(locationError, '');
              hideGuard();
              resolve(true);
            },
            () => {
              setError(locationError, '位置情報の許可が必要です。');
              showGuard(true);
              resolve(false);
            },
            { enableHighAccuracy: false, timeout: 8000 }
          );
        });
      }

      function refreshLocation() {
        if (!navigator.geolocation) return;
        toggleLoading(true);
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            mapState.lastPosition = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            updateDistances();
            setError(locationError, '');
            if (!mapState.centered && mapState.map) {
              mapState.map.setCenter(mapState.lastPosition);
              mapState.map.setZoom(14);
              mapState.centered = true;
            }
            toggleLoading(false);
          },
          () => {
            setError(locationError, '位置情報を取得できませんでした。');
            toggleLoading(false);
          },
          { enableHighAccuracy: false, timeout: 8000 }
        );
      }

      window.initCiquestMap = async function initCiquestMap() {
        if (!STORE_DATA.length) {
          setError(fetchError, '店舗データがありません。');
        }
        mapState.map = new google.maps.Map(document.getElementById('map'), {
          center: defaultCenter,
          zoom: 13,
          styles: MAP_STYLE,
          mapTypeControl: false,
          fullscreenControl: false,
          streetViewControl: false,
        });

        initMarkers();
        await ensureLocationPermission();
        refreshLocation();
        setInterval(refreshLocation, 30000);
      };

      locateButton.addEventListener('click', () => {
        if (mapState.lastPosition && mapState.map) {
          mapState.map.setCenter(mapState.lastPosition);
          mapState.map.setZoom(15);
          return;
        }
        refreshLocation();
      });

      overlay.addEventListener('click', closeSheet);
      guardBtn.addEventListener('click', () => {
        ensureLocationPermission().then((allowed) => {
          if (!allowed) {
            guardHint.style.display = 'block';
          }
        });
      });
    </script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initCiquestMap"
      async
      defer
    ></script>
  </body>
</html>
